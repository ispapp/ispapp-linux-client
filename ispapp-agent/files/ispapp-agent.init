#!/bin/sh /etc/rc.common

START=95
USE_PROCD=1

validate_section() {
    uci_validate_section ispapp settings "" \
        'enabled:bool:1' \
        'login:string' \
        'Domain:string:prv.cloud.ispapp.co' \
        'ListenerPort:uinteger:443' \
        'updateInterval:uinteger:1'
    return $?
}

start_service() {
    validate_section || return 1
    
    # Check if service is enabled
    local enabled
    config_get_bool enabled "settings" "enabled" 1
    [ "$enabled" -eq 0 ] && return 0
    
    procd_open_instance
    procd_set_param command /usr/bin/ispapp-agent
    procd_set_param respawn ${respawn_threshold:-3600} ${respawn_timeout:-5} ${respawn_retry:-5}
    procd_set_param stdout 1
    procd_set_param stderr 1
    
    # Set UCI config as reload trigger
    procd_set_param file /etc/config/ispapp
    
    procd_close_instance
    
    # Mark as connected when service starts
    uci set ispapp.settings.connected=1
    uci commit ispapp
}

service_stopped() {
    # Mark as disconnected when service stops
    uci set ispapp.settings.connected=0
    uci commit ispapp
}

service_triggers() {
    procd_add_reload_trigger "ispapp"
}

reload_service() {
    stop
    start
}
